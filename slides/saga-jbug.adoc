:source-highlighter: highlightjs
:revealjs_theme: redhat
:revealjs_controls: false
:revealjs_center: true
:revealjs_transition: fade

:images: ./misc


= Transactions over REST for microservices

Ondra Chaloupka / ochaloup@redhat.com

== !

image:{images}/saga/wfly_narayana.png[role="noborder"]

[NOTE.speaker]
--
* Red Hat (https://developers.redhat.com)
* Wild Fly (http://wildfly.io)
* Naryana (http://narayana.io)
--

== !

image:{images}/saga/narayana_logo.png[role="noborder"]

* earlier *Arjuna*, renamed to *Narayana*

* *JTA* implementation in JBoss/WildFly
* *JTS* distributed transaction over IIOP
* webservice transactions (*WS-AT/WS-BA*)
* *STM* proof-of-concept for Vert.x
* *saga* transactions over REST

[NOTE.speaker]
--
* Sagas
* Saga transactions
* Business Activities (BA)
* Long running actions (LRA)
* Long Living transactions (LLT)
--

== Agenda

* microservices
* distributed transactions and two-phase commit
* saga
* Narayana Long Running Actions

== Microservice

TODO: ...

image:{images}/entertain/wtf2.jpg[role="noborder"]

== Microservice architecture

image:{images}/saga/posta-msa.png[role="noborder", .stretch]

(_credit: Christian Posta, http://blog.christianposta.com_)

[NOTE.speaker]
--
* Martin Fowler: https://martinfowler.com/articles/microservices.html
* Burr Sutter: https://www.youtube.com/watch?v=35_yWad7IiQ
* Christian Posta: http://blog.christianposta.com/microservices/the-hardest-part-about-microservices-data
--

== Distributed transactions

image:{images}/saga/posta-msa-with-wfly.png[role="noborder", .stretch]

== An ACID transaction

* An atomic unit of the work where everything or nothing is finished
** usually in regards of data manipulation
* Protecting shared resources from multiple users
* A notion of a global consensus
* ACID properties guaranteed

== !

image:{images}/saga/test-tubes.png[role="noborder"]

* [red]#A#&#144;tomicity
* [orange]#C#&#144;onsistency
* [green]#I#&#144;solation
* [blue]#D#&#144;urability

[NOTE.speaker]
--
*Atomicity*::
  "all or nothing", all operations in a transaction succeed or every operation is rolled back
*Consistency*::
  on the completion of a transaction, the database is structurally sound
  that covers e.g. preserve foreign keys, uniqueness defined by schema etc.
*Isolation*::
  transactions do not contend with one another. Contentious access to data is moderated by the database
  so that transactions appear to run sequentially.
*Durability*::
  the results of applying a transaction are permanent, even in the presence of failures

* Martin Kleppmann: https://www.youtube.com/watch?v=5ZjhNTM8XU8
--

== Distributed vs. XA transaction

* distributed transaction runs over multiple services
* XA transaction joins operations over multiple resources

== XA transaction: 2PC

image:{images}/saga/2pc.png[role="noborder", .stretch]

[NOTE.speaker]
--
* XA transaction coordinates non-homogenous participants
* scaling troubles in distributed environment
* https://developer.jboss.org/wiki/TwoPhaseCommit2PC
--

== Distributed transactions



== Distributed transactions: assuming

* closely coupled environment
** harder to scale
** tight data coupling
* short duration
** locking reduces parallelism

== Microservice architecture: expecting

* loosely coupling
* scaling
* long duration activities

== Sagas

* Enventual consistency - relaxing ACID properties
* Saga paper (H. Garcia-Molina, K. Salem;  1987)
* Web services: WS-BA specification, SOA design pattern
* REST and event sourcing: microservices

[NOTE.speaker]
--
Original paper talks about Saga as a solution for long-lived database transactions.
We can use it for distributed environment too for not using two phase commit (a.k.a. locks).

Other names

* Saga action, Saga transactions
* Compensating transactions, compensation transaction
* long running actions

* https://www.cs.cornell.edu/andru/cs711/2002fa/reading/sagas.pdf (Princeton University, 1987)
* http://jbossts.blogspot.cz/2017/06/sagas-and-how-they-differ-from-two.html
* http://microservices.io/patterns/data/saga.html
* https://www.youtube.com/watch?v=0UTOLRTwOX0 (JOTB17, Distributed Sagas: A Protocol for Coordinating Microservices, Caitie McCaffrey)
* http://docs.oasis-open.org/ws-tx/wstx-wsba-1.1-spec-os/wstx-wsba-1.1-spec-os.html (Web Services Business Activity, 2007)
*
--


== Sagas (2)

image:{images}/saga/saga_confirm.png[role="noborder", .stretch]

* responsibility of failures handling to developer
* hooks to be called on confirm or failure


== Sagas (3)

image:{images}/saga/saga_compensate.png[role="noborder", .stretch]

* compensation hook called by transaction manager
* compensation action defined by developer

[NOTE.speaker]
--
Concept of long lived transaction.

The Saga defines unit of work work that could be aborted and we relax isolation.

Standard ACID transaction is expected to be a short amount of work done in short time.
This expectation is based on the fact that ACID transaction holds resources (locks)
and prevents other concurrent transaction using the same data to proceed (mainly when the
both of them hit writing the same record, reading concurrently could be somehow solved by MVCC - Snapshot isolation).

What if we want to have long transaction spans request over network (WS, REST) combined with insertion to a database.
What if we consider popular example of reserving a flight, taxi to a hotel and the hotel,
which we would like to be a single operation in high level point of view - I mean when I book a hotel from some date,
I need to be sure that the flight for that date is booked too and having taxi on particular date being prepared
for me. Confirmation of the hotel could take "long" time and during that time I need to hold reservation
for the flight. When booking fails I need to cancel the flight reservation too. At this particular example
it's suitable to hold resources (locks) as it could block other reservation to happen.

This is really popular example in many articles and it is in fact real for many use cases.
But what is important is that pointing to the fact that
holding resources/locks (for long time) could be a bad fit which not permitting concurrent operation to proceed.
This is something with current systems have to fight with.

Trend of holding locks is represented by well-known two phase commit protocol where
each resource - each participant of the transaction (it could be a database, WS/REST call, JMS...)
starts its own local transaction and that local transaction holds resources of particular system
(it holds locks on the resource, implementation depends system - in example of DB as mentioned
there is MVCC which does not lock for concurrent reads). The resource is hold during the whole time
of processing until commit is called on the local transaction.

How to not holding lock and permit higher transaction throughput? The answer could be Saga.
Even we didn't define it so far we can say it comes with idea of splitting this big
transaction to small ones where each local transaction is finished as soon as possible
and the set of the already finished transactions defines a work of unit. This breaks
ACID isolation right at the place but Saga provides handling to grant atomicity.
--


== Saga transaction

image:{images}/saga/saga.png[role="noborder", .stretch]

[NOTE.speaker]
--
The concept of the original paper talks about single node database but it could
be applied to distributed transactions (as was already shown).

Saga could be classified as `Base` transaction (at least from my understanding)
as it does not lock resources a.k.a locks and letting data of resources being available
for other transactions to work with.

As you could see the transaction handling introduced by Saga requires the application to
define compensation actions or define actions as idempotent (you can repeat operation on the
resource multiple times and you will get the same result - operation being repeated not leading to a different outcome).

Still you can handle all the data integrity yourself in your application and design your system architecture
to handle with failures. It's up to you if concept of Saga is useful for you or not.

* https://www.cs.cornell.edu/andru/cs711/2002fa/reading/sagas.pdf (Sagas, Priceton University, 1987)
* http://queue.acm.org/detail.cfm?id=1394128 (Base: An Acid Alternative, base transactions)
* https://www.atomikos.com/Blog/ACAPSolutionProvingBrewerWrong (A CAP Solution (Proving Brewer Wrong) aka CQRS)
--


== Narayana and Sagas

* XTS: WS-BA (Web Services Business Activity)
* Compensating transactions (CDI annotations)
* LRA (Long Running Actions, over REST)

[NOTE.speaker]
--
* https://developer.jboss.org/wiki/CompensatingTransactionsWhenACIDIsTooMuch (Narayana: Compensating Transactions: When ACID is too much)
--


== Narayana LRA

[source,java,role="stretch"]
----
@Inject
private AlohaService alohaService;

@Inject
private LRAClientAPI lraClient;

@GET
@Path("/hello")
@LRA(value = LRA.Type.REQUIRED)
public List<String> hello() {
    alohaService.aloha(lraClient.getCurrent())
}

@POST
@PUT("/complete")
@Complete
public Response completeWork(@HeaderParam(LRAClient.LRA_HTTP_HEADER) String lraId) {
    String txId = LRAClient.getLRAId(lraId);
    System.out.printf("ActivityController completing %s%n", txId);
    return Response.ok().build();
}

@POST
@Path("/compensate")
@Compensate
public Response compensateWork(@HeaderParam(LRAClient.LRA_HTTP_HEADER) String lraId) {
    String txId = LRAClient.getLRAId(lraId);
    System.out.printf("ActivityController compensating %s%n", txId);
    return Response.ok().build();
}
----

[transition=slide, %notitle]
=== Calls diagram

image:{images}/saga/msa_calls.png[role="noborder", .stretch]


== !

image:{images}/saga/microprofile.jpg[role="noborder", 50%]

* Java EE stack for microservices
* https://github.com/jbosstm/microprofile-sandbox/blob/0009-LRA/proposals/0009-LRA/0009-LRA.md[LRA specification proposal, https://github.com/jbosstm/microprofile-sandbox]
* https://groups.google.com/forum/#!msg/microprofile/CJirjFkM9Do/TrApz-fBDQAJ[Microprofile Google group, http://bit.ly/transactions-microprofile]


[NOTE.speaker]
--

Event driven transactions

  * https://docs.axonframework.org/part2/sagas.html (Axon: Managing complex business transactions)
  * http://eventuate.io (Solving distributed data management problems in a microservice architecture)
  * https://docs.particular.net/nservicebus/sagas (Particular Software : .NET/Windows, Sagas)

Atomicos TCC

  * https://www.atomikos.com/Main/DownloadPublications?article=TransactionsForSOA-WhitePaper.pdf (Atomicos: Composite	Transactions for SOA)
  * https://www.infoq.com/presentations/Transactions-HTTP-REST (Atomicos: Transactions for the REST of Us, presentation)
--


== !

image:{images}/entertain/cajk.jpg[role="noborder", , height="300"]
